@using Lumina_Hospital.Entities.Appointments
@model Appointment
<!-- Doctor appointment banner start -->


<!-- Doctor appointment banner end -->
<div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Event Title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="form-group">
                        <label for="eventTitle">Title:</label>
                        <input type="text" class="form-control" id="eventTitle" required>
                    </div>

                    <div class="form-group">
                        <label for="selectDoctor">Select Doctor:</label>
                        <select class="form-control" id="selectDoctor" required>
                            <option value="">Select a doctor</option>
                            @foreach (var doctor in ViewBag.Doctors)
                            {
                                <option value="@doctor.Id">@doctor.Name</option>
                            }
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="selectTimeSlot">Select Time Slot:</label>
                        <select class="form-control" id="selectTimeSlot" required>
                            <option value="">Select a time slot</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">Save</button>
                </form>

            </div>
        </div>
    </div>
</div>

<div class="container distance">

    <div id="calendar"></div>
    
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            headerToolbar: {
                left: 'prev,next',
                center: 'title',
                right: ''
            },
            initialDate: new Date(),
            
            navLinks: true, 
            selectable: true,
            selectMirror: true,
            select: function (arg) {
                $('#eventModal').modal('show');

                $('#selectDoctor').change(function () {
                    var doctorId = $(this).val();
                    loadAvailableTimes(doctorId);
                });

                $('#eventForm').on('submit', function (e) {
                    e.preventDefault();

                    var title = $('#eventTitle').val();
                    if (title) {
                        $.ajax({
                            type: "POST",
                            url: "/Appointment/Assignment",
                            data: {
                                title: title,
                                start: arg.start.toISOString(),
                                end: arg.end.toISOString(),
                                doctorId: $('#selectDoctor').val(),
                                time: $('#selectTimeSlot').val(),
                            },
                            success: function (response) {
                                if (response.success) {
                                    calendar.addEvent({
                                        title: title,
                                        start: arg.start,
                                        end: arg.end,
                                        allDay: arg.allDay
                                    });
                                } else {
                                    alert("error.");
                                }
                            },
                            error: function () {
                                alert("appointment not saved.");
                            }
                        });

                        $('#eventModal').modal('hide');
                    }
                });

                calendar.unselect();
            },

            eventClick: function (arg) {
                if (confirm('Are you sure you want to delete this event?')) {
                    arg.event.remove()
                }
            },
            editable: true,
            dayMaxEvents: true,
            events: [
                // {
                //     title: 'All Day Event',
                //     start: '2020-09-01'
                // },
                // {
                //     title: 'Long Event',
                //     start: '2020-09-07',
                //     end: '2020-09-10'
                // },
                
            ]
        });

        calendar.render();
    });

    function loadAvailableTimes(doctorId) {
        const selectTimeSlot = $('#selectTimeSlot');
        selectTimeSlot.empty(); 

        if (doctorId) {
            $.ajax({
                type: "GET",
                url: "/Appointment/GetDoctorAvailability",
                data: { doctorId: doctorId },
                success: function (response) {
                    if (response && response.length > 0) {
                        response.forEach(function (availability) {
                            selectTimeSlot.append(`<option value="${availability}">${availability}</option>`);
                        });
                    } else {
                        alert("doctors have not available time.");
                    }
                },
                error: function () {
                    alert("Error. not loading .");
                }
            });
        }
    }



</script>
